name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Choose version bump type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
          - custom
        default: patch
      custom_version:
        description: 'Custom version (only if "custom" selected above, e.g., 1.0.0-beta.1)'
        required: false
        type: string
      prerelease:
        description: 'Mark as prerelease'
        required: false
        default: false
        type: boolean

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-15

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Configure Git
        run: |
          git config user.name "godot-iap bot"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Calculate version
        id: version
        run: |
          # Get current version from plugin.cfg
          CURRENT_VERSION=$(grep -E '^version=' addons/godot-iap/plugin.cfg | cut -d'"' -f2)
          echo "Current version: $CURRENT_VERSION"

          if [ "${{ inputs.version }}" = "custom" ]; then
            # Validate custom version format (semver with optional prerelease)
            CUSTOM_VERSION="${{ inputs.custom_version }}"
            if ! echo "$CUSTOM_VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$'; then
              echo "Error: Invalid version format. Must be semver (e.g., 1.0.0 or 1.0.0-beta.1)"
              exit 1
            fi
            NEW_VERSION="$CUSTOM_VERSION"
          else
            # Parse current version (handle both X.Y.Z and X.Y.Z-suffix formats)
            BASE_VERSION="${CURRENT_VERSION%%-*}"
            IFS='.' read -r MAJOR MINOR PATCH <<< "$BASE_VERSION"

            case "${{ inputs.version }}" in
              major)
                MAJOR=$((MAJOR + 1))
                MINOR=0
                PATCH=0
                ;;
              minor)
                MINOR=$((MINOR + 1))
                PATCH=0
                ;;
              patch)
                PATCH=$((PATCH + 1))
                ;;
            esac
            NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
          fi

          echo "New version: $NEW_VERSION"
          echo "VERSION=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Update version in plugin.cfg
        run: |
          sed -i '' 's/^version=.*/version="${{ steps.version.outputs.VERSION }}"/' addons/godot-iap/plugin.cfg
          cat addons/godot-iap/plugin.cfg

      - name: Sync OpenIAP versions
        run: |
          chmod +x scripts/sync-versions.sh
          ./scripts/sync-versions.sh

      # Build Android first (faster, fail fast)
      - name: Download godot-lib.aar
        run: |
          mkdir -p android/libs
          curl -L -o android/libs/godot-lib.aar \
            "https://github.com/godotengine/godot/releases/download/4.3-stable/godot-lib.4.3.stable.template_release.aar"

      - name: Build Android AAR
        run: |
          cd android
          chmod +x gradlew
          ./gradlew assembleRelease

      # iOS frameworks are pre-built and committed to git for faster CI
      - name: Verify iOS Frameworks
        run: |
          if [ ! -d "addons/godot-iap/bin/ios/GodotIap.framework" ]; then
            echo "Error: iOS frameworks not found in repository"
            echo "Please run 'make ios' locally and commit the frameworks"
            exit 1
          fi
          echo "âœ“ iOS frameworks found"
          ls -la addons/godot-iap/bin/ios/

      - name: Prepare addon directory
        run: |
          mkdir -p dist/addons/godot-iap/android
          mkdir -p dist/addons/godot-iap/bin/ios

          # Copy GDScript files
          cp addons/godot-iap/*.gd dist/addons/godot-iap/
          cp addons/godot-iap/plugin.cfg dist/addons/godot-iap/

          # Copy Android AARs (both release and debug for export compatibility)
          cp android/build/outputs/aar/godot-iap-release.aar dist/addons/godot-iap/android/GodotIap.release.aar
          # Create debug AAR from release (Godot needs debug.aar for debug exports)
          cp android/build/outputs/aar/godot-iap-release.aar dist/addons/godot-iap/android/GodotIap.debug.aar

          # Create GDAP file for Android plugin with exact version from openiap-versions.json
          OPENIAP_GOOGLE_VERSION=$(cat openiap-versions.json | grep '"google"' | cut -d'"' -f4)
          cat > dist/addons/godot-iap/android/GodotIap.gdap << EOF
          [config]
          name="GodotIap"
          binary_type="local"
          binary="GodotIap.release.aar"

          [dependencies]
          local=[]
          remote=["com.android.billingclient:billing:7.1.1", "io.github.hyochan.openiap:openiap-google:${OPENIAP_GOOGLE_VERSION}"]
          EOF

          # Copy iOS frameworks (pre-built and committed to git)
          cp -R addons/godot-iap/bin/ios/GodotIap.framework dist/addons/godot-iap/bin/ios/
          cp -R addons/godot-iap/bin/ios/SwiftGodotRuntime.framework dist/addons/godot-iap/bin/ios/

          # Create GDExtension config for iOS
          cat > dist/addons/godot-iap/bin/ios/godot_iap.gdextension << 'EOF'
          [configuration]
          entry_symbol = "godot_iap_entry_point"
          compatibility_minimum = "4.3"
          supported_platforms = ["ios"]

          [libraries]
          ios.arm64 = "GodotIap.framework/GodotIap"
          # Dummy entries for editor (prevents load errors on non-iOS)
          macos = ""
          windows = ""
          linux = ""

          [dependencies]
          ios.arm64 = {"SwiftGodotRuntime.framework/SwiftGodotRuntime": ""}
          EOF

      - name: Create release zip
        run: |
          cd dist
          zip -r ../godot-iap-${{ steps.version.outputs.VERSION }}.zip addons

      - name: Commit version bump and create tag
        run: |
          git add addons/godot-iap/plugin.cfg
          # Only commit if there are staged changes
          if git diff --cached --quiet; then
            echo "No version changes to commit (version already set)"
          else
            git commit -m "chore(release): ${{ steps.version.outputs.VERSION }}"
          fi
          git tag -f ${{ steps.version.outputs.VERSION }}
          git push --follow-tags

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.VERSION }}
          name: ${{ steps.version.outputs.VERSION }}
          files: godot-iap-${{ steps.version.outputs.VERSION }}.zip
          generate_release_notes: true
          draft: false
          prerelease: ${{ inputs.prerelease }}
